# CH6-4

## 网桥与二层（链路层）交换机

### 局域网的互联

- 具备超越单个局域网的扩展能力
- 为其他局域网 / 广域网提供互联通道
- 需使用网桥（后来发展为二层交换机）
  - 连接多个局域网（通常不少于两个）
  - 物理层和 MAC 层协议需保持一致
- 对局域网帧执行存储转发操作
- 实现帧的逐位精确复制
- 需具备交换（路由）功能

![](/home/guan/Desktop/计算机网络/Images/6.14/c27edeba-cf3e-4be5-95d3-319b5dbdda8b.png)

### 网桥的要求

- 存储转发
  - 读取在一个局域网上传输的帧，检查帧的 MAC 地址，有选择地将这些地址存储到其他局域网
  - 使用第二个局域网的 MAC 协议，重新传输每个帧
- 透明性
  - 站点意识不到网桥的存在
- 即插即用，自学习
  - 网桥无需配置

![](/home/guan/Desktop/计算机网络/Images/6.14/e00c4a8b-64b0-445d-a746-317889609c52.png)

### 网桥的机制

- 机制
  - 透明网桥：802.1D
    - 帧广播
    - 环路解析
    - 地址学习

### 广播网络

- 发送方将帧传输到广播链路
- 每个接收方的链路层会将该帧传递给网络层，条件是：
  - 目标地址与接收方的 MAC 地址匹配，或者目标地址为广播 MAC 地址（ff:ff:ff:ff:ff:ff）

![](/home/guan/Desktop/计算机网络/Images/6.14/517fa73e-6336-4d03-b756-a10704aa9751.png)

![](/home/guan/Desktop/计算机网络/Images/6.14/aab7e840-e9c8-4f91-92fa-d77193bd7471.png)

- 以太网是 “即插即用” 的
- 新主机接入以太网即可正常使用
  - 无需用户或网络运营商进行配置
  - 借助广播实现通信的初始化

![](/home/guan/Desktop/计算机网络/Images/6.14/50a7fe05-eca2-45c2-8b81-f6947e8c4732.png)

---

## 广播风暴

![](/home/guan/Desktop/计算机网络/Images/6.14/4c3a64f2-df7d-4d03-ac7f-1ac371338915.png)

![](/home/guan/Desktop/计算机网络/Images/6.14/ed68cf25-45d0-4372-b035-2a81a9407f3c.png)

### 避免环路的最简单方法

- 采用不可能形成环路的拓扑结构！
- 从任意拓扑结构中构建生成树
  - 生成树是包含所有节点但不包含任何环的子图
  - 不在生成树中的链路不会用于转发帧

### 生成树协议（Perlman’85）

- 网桥通过该协议构建生成树
- 具备优良特性
  - 零配置（无需运维人员或用户操作）
  - 自修复能力
- 至今仍在使用

### 生成树算法

1. 将任意网络拓扑作为输入
2. 选取链路子集以形成生成树

### 算法包含两个方面

- 选择根节点
  - 作为最短路径的目标节点
  - 选择标识符（MAC 地址）最小的节点
- 计算到根节点的最短路径
  - 最短路径不能包含环路
  - 仅保留最短路径上的链路
  - 以某种方式打破平局（确保每个节点仅保留一条最短路径）
- 以太网的生成树构建通过单一算法同时实现上述两个方面

### 打破平局

- 当存在多条到根节点的最短路径时，选择使用邻居 ID 较小的路径
- 可以使用任何平局打破机制，但这是一种易于记忆和实现的方式

### 构建生成树

- 消息（Y，d，X）
  - 来自节点 X
  - 提议将 Y 作为根节点
  - 并通告到 Y 的距离 d
- 交换机选举标识符（MAC 地址）最小的节点作为根节点
- 每个节点确定某条链路是否在其到根节点的最短路径上；若不在，则将该链路排除在生成树之外

![](/home/guan/Desktop/计算机网络/Images/6.14/b801166e-71cc-4e3a-b594-d005f1da853d.png)

### 健壮的生成树算法

- 算法必须对故障作出反应
  - 根节点故障
  - 其他网桥和链路故障
- 根节点定期发送根通告消息
  - 其他网桥持续转发消息
- 通过超时机制检测故障
  - 若未收到根节点消息，超时后自荐为根节点！

### 生成树上的洪泛

- 网桥按以下规则执行洪泛：
  - （忽略所有不在生成树上的端口！）
  - 源网桥从所有端口发送数据包
  - 当数据包从某一入向端口到达时，从除该入向端口外的所有端口转发出去

![](/home/guan/Desktop/计算机网络/Images/6.14/149624d1-6c67-44de-aee5-7663bd5e68e7.png)

### 但洪泛不是很浪费吗？

- 是的，但我们可以利用洪泛来初始化更高效的转发机制
- 核心思路：监控经过的数据包并从中学习
  - 若节点 A 从某个特定端口收到节点 B 的数据包，它就知道该通过哪个端口访问 B
- 该机制生效的前提是：到 B 只有一条路径（生成树无环特性保证）

### 节点可 “学习” 路由

- 交换机通过记忆洪泛数据包的来源，学习到达各节点的路径
- 若来自节点 A 的洪泛数据包从网桥的端口 4 进入，则网桥使用端口 4 向节点 A 发送数据

### 地址学习

- 每个网桥维护一个转发数据库

- 转发数据库可通过学习构建：

  - 当帧从端口 X 到达时，该帧来自与端口 X 相连的局域网

  - 利用源地址更新端口 X 的转发数据库，将该地址加入记录
    - 数据库中每个条目设有计时器，计时结束后条目将被删除
    - 每次帧到达时，会将源地址与转发数据库进行比对

![](/home/guan/Desktop/计算机网络/Images/6.14/5237c752-b9cf-47b1-886e-4e8fb9562aa6.png)

![](/home/guan/Desktop/计算机网络/Images/6.14/c2118a72-5174-43ce-981a-c811e3e42d0f.png)

![](/home/guan/Desktop/计算机网络/Images/6.14/1ab64451-4ca6-46bb-9496-61b572970805.png)

![](/home/guan/Desktop/计算机网络/Images/6.14/cc15789b-8d17-4096-b568-fa1e222868a8.png)

![](/home/guan/Desktop/计算机网络/Images/6.14/df29aed7-10b9-4f0c-bc15-3fdc7d15ff11.png)

### 网桥帧转发总结

- **维护各端口的转发数据库**
  - 数据库条目格式：<MAC 地址，端口，时间戳>，记录通过各端口可达的站点地址。

- **帧到达端口 X 时的处理逻辑**

1. **查询转发数据库**：检查目标 MAC 地址是否存在于任意端口的记录中。

2. **若目标地址未找到**：向除 X 外的所有端口洪泛转发（Flooding）。

3. **若目标地址对应端口 X**：丢弃该帧（避免本地环路）。

4. 若目标地址对应端口 Y

   ：

   - 检查端口 Y 的状态：若为**转发状态（Forwarding）**，则传输帧；
   - 若为**阻塞状态（Blocking）**，则不转发（阻塞状态用于生成树构建，避免环路）。

- **核心机制补充**

  - 转发数据库通过**地址学习**动态更新（基于帧的源地址和入端口），并通过时间戳淘汰过期条目，确保信息时效性。

  - 洪泛作为初始阶段的 “探索” 手段，配合生成树协议（STP）消除环路，最终实现高效无环的转发路径。

### 局域网互联设备类型

- **集线器（Hubs）**：物理层中继器，仅放大电信号，所有端口共享带宽，属于冲突域（Collision Domain）。

-  **网桥（Bridges）**：

  - 工作于数据链路层（Layer 2），连接多个局域网。

  - 核心功能：基于 MAC 地址转发帧 + 通过地址学习构建转发数据库。

  - 分割冲突域，提升网络效率。

- **二层交换机（Layer 2 Switches）**：

  - 本质为多端口网桥，连接主机或局域网。

  - 集成网桥功能（转发、学习、过滤），且每个端口独立构成冲突域（冲突 - free）。

  - 支持高速数据交换，常用于构建局域网内部架构。

-  **三层交换机（Layer 3 Switches）**：

  - 融合二层交换功能与三层路由功能（支持 IP 路由、VLAN 间通信等）。

  - 兼具交换机的高速转发能力和路由器的网络层寻址功能，适用于大型网络的三层互联。

### 集线器

- 星型拓扑结构的主动核心组件
- 每个工作站通过两条线路与集线器相连
  - 具备发送和接收功能
- 集线器充当信号中继器
  - 当某一工作站发送数据时，集线器会将信号通过输出线路转发至所有其他工作站
- 物理结构为星型，逻辑结构为总线型
  - 任意工作站的传输内容可被所有其他工作站接收
  - 若两个工作站同时发送数据，会发生冲突

![](/home/guan/Desktop/计算机网络/Images/6.14/7cb50f32-a7e6-41ad-a753-df8747495454.png)

### 二层交换机：需求

- 链路层设备，起主动作用
  - 存储并转发以太网帧
  - 检查输入帧的 MAC 地址，当帧需要在网段转发时，有选择地将帧转发至一个或多个输出链路，使用 CSMA/CD 访问网段
- 透明性：主机意识不到交换机的存在
- 即插即用，自学习：交换机无需配置

- 交换机 vs. 网桥

  - 网桥：连接局域网（通常 2-4 个端口）

  - 交换机：连接多个主机 / 子网（端口数量多，可实现无冲突传输）

### 为何使用交换式以太网？

- 工作站与交换机之间为专用直连
- 交换机对帧进行缓存和转发
- 每个输入链路上均使用以太网协议，但无冲突；支持全双工模式
  - 每条链路独立构成一个冲突域
- 交换功能允许 A 到 A’和 B 到 B’同时传输数据且无冲突
- 提升局域网的容量
  - 每个端口 / 链路形成一个局域网网段（无冲突）
  - 支持多个工作站同时发送数据

![](/home/guan/Desktop/计算机网络/Images/6.14/4a7baf0e-26c8-475e-8dbe-2633e167f28f.png)

### 二层交换机的优势

- 将总线 / 集线器局域网转换为交换式局域网时，无需对所连接的工作站进行改动
  - 对于以太网局域网，每个工作站均使用以太网 MAC 协议
- 工作站拥有与原始局域网相当的专用带宽
  - 前提是交换机具备足够容量以匹配所有工作站的需求
- 二层交换机易于扩展
  - 可通过添加新的二层交换机来容纳更多工作站

交换机互联
❖ 交换机之间可以相互连接

![](/home/guan/Desktop/计算机网络/Images/6.14/96ff231d-dadc-49c6-97e9-ed1809e76043.png)

![](/home/guan/Desktop/计算机网络/Images/6.14/827e21d4-1b40-4b8b-90d7-33892f6f0fbe.png)

![](/home/guan/Desktop/计算机网络/Images/6.14/34f56ee8-3836-4c12-b49a-2d9471dc1211.png)

![](/home/guan/Desktop/计算机网络/Images/6.14/fae71ce5-2b12-4b48-a10e-87ac3dac8102.png)

### 交换机帧转发总结

当交换机接收到帧时：

1. 记录输入链路及发送主机的 MAC 地址
2. 使用 MAC 目的地址检索交换机转发表
3. 若找到目的地址条目
   则 {
   若目的地址位于帧到达的网段
   则丢弃该帧
   否则按条目指示的接口转发帧
   }
   否则执行泛洪操作 /* 向除输入接口外的所有接口转发 */

### 三层交换机

- 随着工作站数量的增长，二层交换机的不足逐渐显现
  - 广播风暴过载
  - 缺乏多路径支持
- 三层交换机
  - 在硬件中实现路由器的数据包转发（IP）逻辑
  - 与二层交换机类似，用于互联相似的局域网

### 广播过载

- 由二层交换机连接的工作站与局域网构成单一物理网络
- 所有节点共享通用的 MAC 广播地址
- 广播帧会被传送到所有连接在二层交换机所连局域网上的工作站
- 在广播场景下，二层交换机会退化为集线器
- 日常工作中，IP 协议会引发大量广播，例如 ARP、DHCP、IGMP 等

### 缺乏多路径

- 二层交换机使用生成树协议进行路由（交换）
- 规定不存在闭合环路：任意两个工作站之间仅有一条路径
- 这同时限制了性能和可靠性

- 解决方案：
  - 利用路由器功能（三层交换机）将局域网划分为由交换机连接的子网
  - 将 MAC 广播帧限制在单个子网内
  - 允许子网间使用多条路径

### 组织中的典型大型局域网

- 图中圆圈标识独立的局域网子网
- MAC 广播帧被限制在其所在子网内

![](/home/guan/Desktop/计算机网络/Images/6.14/64f9cb31-42b7-4de6-a42f-0355d58610c2.png)

![](/home/guan/Desktop/计算机网络/Images/6.14/e07978ed-df7a-490d-8c7b-83519aa1bc3e.png)