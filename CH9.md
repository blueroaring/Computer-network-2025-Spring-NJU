# CH9

![](/Images/395f959c-6a68-45fe-867b-cdccc1a8bd7f.png)

---

## 多媒体网络应用

### 多媒体：音频

❖ 以恒定速率对模拟音频信号进行采样
▪ 电话：8,000 样本 / 秒
▪ 光盘音乐：44,100 样本 / 秒
❖ 对每个样本进行量化（即取整）
▪ 例如，2⁸=256 种可能的量化值
❖ 码率示例
▪ 光盘：1.411 兆比特 / 秒
▪ MP3：96、128、160 千比特 / 秒
▪ 互联网电话：5.3 千比特 / 秒及以上

![](/Images/43081a69-392a-4d15-a7ec-01f1410c2a03.png)

### 多媒体：视频

数字图像是像素的阵列
▪ 每个像素由比特表示
编码：利用图像内和图像间的冗余来减少编码图像所需的比特数
▪ 空间（图像内）
▪ 时间（从一帧图像到下一帧）
示例：
▪ 时间编码示例：不是在 i+1 时刻发送完整帧，而是只发送与 i 帧的差异
▪ MPEG 1（CD-ROM）1.5 兆比特 / 秒
▪ MPEG2（DVD）3-6 兆比特 / 秒
▪ MPEG4（常用于互联网，<1 兆比特 / 秒）
空间编码示例：对于相同颜色（全为紫色）的 N 个值，只发送两个值：颜色值（紫色）和重复值的数量（N）
视频：以恒定速率显示的图像序列
▪ 例如 24 帧 / 秒

![](/Images/1e1b444a-0762-43ad-b373-995721726274.png)

### 三种应用类型

❖ 流式传输、存储的音频和视频
▪ 流式传输：可在下载完整文件前开始播放
▪ 存储（在服务器上）：传输速度可快于音视频的渲染速度（意味着在客户端存储 / 缓冲）
▪ 例如：YouTube、Netflix、Hulu
❖ 基于 IP 的会话式语音 / 视频
▪ 人与人对话的交互特性限制了对延迟的容忍度
▪ 例如：Skype
❖ 流式直播音频、视频
▪ 例如：体育赛事直播（足球）

![](/Images/3468470c-1fed-4358-b69e-30b5b936f19d.png)

### 流式存储视频：挑战

❖ 连续播放约束：客户端一旦开始播放，播放必须与原始时序匹配
▪…… 但网络延迟具有可变性（抖动），因此需要客户端缓冲区来满足播放要求
❖ 其他挑战：
▪ 客户端交互性：暂停、快进、快退、跳转视频
▪ 视频数据包可能丢失或重传

### 流式存储视频：再探

❖ 客户端缓冲与播放延迟：
用于补偿网络引入的延迟及延迟抖动

![](/Images/daf881d0-76db-4d51-bd4b-b56d044530f5.png)

![](/Images/924890d6-111b-46f8-bdae-ceb6563e484f.png)

### 客户端缓冲与播放

1. 初始填充缓冲区，直至在时间 tp 开始播放
2. 于时间 tp 开始播放
3. 缓冲区填充水平随时间变化，原因是填充速率 x (t) 波动而播放速率 r 保持恒定

![](/Images/beb8a9e6-8d59-4b9c-935f-7668f64da874.png)

播放缓冲：平均填充速率（x）与播放速率（r）的关系：

- 若 x < r：缓冲区最终会清空（导致视频播放卡顿，直至缓冲区重新填充）
- 若 x > r：只要初始播放延迟足够大以吸收 x (t) 的波动，缓冲区就不会清空
- 初始播放延迟的权衡：延迟越大，缓冲区耗尽的可能性越低，但用户开始观看前的等待时间也越长

![](/Images/abd3c6cf-871e-4083-a8af-5b516238d4fe.png)

### 流式多媒体：UDP

❖ 服务器按适合客户端的速率发送
▪ 通常：发送速率 = 编码速率 = 恒定速率
▪ 传输速率可忽略拥塞程度
❖ 短播放延迟（2-5 秒）以消除网络抖动
❖ 错误恢复：应用层（时间允许时）
❖ RTP [RFC 2326]：多媒体有效载荷类型
❖ UDP 可能无法通过防火墙

### 流式多媒体：HTTP

- 通过 HTTP GET 检索多媒体文件
- 在 TCP 协议下以最大可能速率发送
- 由于 TCP 拥塞控制和重传机制（有序传输），填充速率会出现波动
- 需更大的播放延迟：用于平滑 TCP 的传输速率
-  HTTP/TCP 更易穿过防火墙

![](/Images/ba507e7d-6fec-4712-bb4e-c4dd9d270d73.png)

### 流式多媒体：DASH

❖ DASH：基于 HTTP 的动态自适应流媒体

❖ 服务器：

▪ 将视频文件分割为多个数据块

▪ 每个数据块以不同码率存储和编码

▪ 清单文件：提供不同数据块的 URL 地址

❖ 客户端：

▪ 定期测量服务器到客户端的带宽

▪ 参考清单文件，逐次请求单个数据块

- 根据当前可用带宽选择可支持的最大编码码率
- 可在不同时间点选择不同编码码率（取决于当时的可用带宽）

### 流式多媒体：DASH

- DASH：基于 HTTP 的动态自适应流媒体
- 客户端具备 “智能” 功能：客户端可确定
  - 何时请求数据块（避免缓冲区耗尽或溢出）
  - 请求何种编码码率（带宽充足时选择更高质量）
  - 从何处请求数据块（可从与客户端 “距离近” 或可用带宽高的 URL 服务器请求）

### 互联网协议语音（VoIP）

- VoIP 的端到端延迟要求：需维持 “会话” 特性
  - 延迟过高会被察觉，影响交互性
  - ＜150 毫秒：良好
  - ＞400 毫秒：不良
  - 包括应用层延迟（分组化、播放）和网络延迟
- 会话初始化：被叫方如何通告 IP 地址、端口号及编码算法？
- 增值服务：呼叫转移、筛选、录音
- 紧急服务：911

### 互联网协议语音（VoIP）：分组丢失与延迟

- 网络丢包：IP 数据报因网络拥塞（路由器缓冲区溢出）而丢失
- 延迟丢包：IP 数据报到达接收端时已超过播放截止时间
  - 延迟来源：网络中的处理延迟、队列延迟；端系统（发送方、接收方）延迟
  - 典型最大容忍延迟：400 毫秒
- 丢包容忍度：取决于语音编码与丢包隐藏技术，1% 至 10% 的丢包率可被容忍

### Skype

- 点对点互联网协议语音（VoIP）应用
  - 支持电脑对电脑、电脑对电话、电话对电脑的通信
- 采用专有应用层协议

![](/Images/860b65a8-34cd-483f-b12b-6c67aea0004f.png)

### Skype：拨打电话

- 用户启动 Skype
- 客户端（SC）向超级节点（SN）注册
- 客户端登录（进行身份验证）
- 呼叫：客户端携带被叫方 ID 联系超级节点（SN）
- 超级节点联系其他超级节点以查找被叫方地址
- 客户端通过 TCP 直接联系被叫方

### Skype 与 NAT 协同工作

- 问题：爱丽丝和鲍勃均处于 “网络地址转换（NAT）” 设备之后
- NAT 会阻止外部对等方主动向内部对等方发起连接
- 但内部对等方可主动向外部发起连接
- ❖ 中继解决方案：爱丽丝和鲍勃与各自的超级节点（SN）保持开放连接
- ▪ 爱丽丝向其超级节点发送信号，请求连接鲍勃
- ▪ 爱丽丝的超级节点连接至鲍勃的超级节点
- ▪ 鲍勃的超级节点通过鲍勃最初主动建立的开放连接与鲍勃相连

---

## 实时传输协议

## RTP（实时传输协议）/RTCP（实时传输控制协议）/RTSP（实时流协议）/SIP（会话初始协议）

![](/Images/3e4b3a3f-df03-4412-b7f3-de644f65d7f7.png)

![](/Images/db4e9da3-2d5a-430c-88c4-17d44e1316c1.png)

![](/Images/d4e8ef59-2855-4888-a70a-4f05b57193d5.png)

![](/Images/597cd38b-fd39-4bee-bfff-6b97779fc2ce.png)

### RTP 如何工作

- 时间戳 —— 这是实时应用中最重要的信息。
  - 发送方根据数据包中首个字节的采样时刻生成时间戳。
  - 接收方利用时间戳重建原始时序。
  - 时间戳也用于同步不同流（如 MPEG 中的音频和视频流），实际同步由应用层负责。

- 有效载荷类型标识符
  - 用于指定有效载荷格式以及编码 / 压缩方案
  - 应用程序借此知晓如何解析有效载荷
- 源标识
  - 音频会议

### RTP 与服务质量（QoS）

- RTP 不提供任何确保数据及时交付的机制
- RTP 封装仅在终端系统可见，中间路由器无法识别
- 路由器不会对 RTP 数据包做特殊处理

### RTP 数据包

- 有效载荷类型（7 位）：指示当前使用的编码类型。
- 序列号（16 位）：每发送一个 RTP 数据包，该序列号递增 1。
- 用于检测数据包丢失并恢复数据包顺序。
- 时间戳字段（32 位）：标记此 RTP 数据包中首个字节的采样时刻。
- SSRC 字段（32 位）：标识 RTP 流的来源。
- RTP 会话中的每个流都有唯一的 SSRC。

![](/Images/5d048395-4228-49f2-a654-c7288e9b565c.png)

### 实时传输控制协议（RTCP）

- 规定了在发送源和接收方之间交换的报告协议数据单元（PDU）
- 与 RTP 协同工作
- RTP 会话中的每个参与者定期向所有其他参与者发送 RTCP 控制数据包

- 每个 RTCP 数据包包含发送方和 / 或接收方报告
  - 接收方接收报告
    - 反馈数据传输情况
    - 丢包数、抖动、时间戳
- 发送方报告
  - 中间媒体同步、发送字节数
- 源描述报告
- 报告包含发送 RTP-PDU 数量、RTP-PDU 丢失数量、到达间隔抖动等统计信息
- 反馈用于控制性能
  - 发送方可能修改传输速率以用于诊断目的

### RTCP 提供以下服务：

- 服务质量（QoS）监控与拥塞控制
  - 主要功能：向应用程序反馈 QoS 信息
  - 发送方可据此调整传输策略
  - 接收方可判断拥塞是局部、区域还是全局范围的
  - 网络管理员可评估组播分发的网络性能
- 源标识
- 媒体间同步
- 控制信息缩放
  - 控制流量限制（控制流量最多占整个会话流量的 5%）

### 实时流协议（RTSP）

- 参考 RFC 2326 标准
-  一种应用层协议，用于建立和控制端点之间的媒体会话
- 支持类似录像机（VCR）的控制命令：倒带、快进、暂停、继续、定位等
- 可基于 UDP 或 TCP 实现，命令以 ASCII 文本格式发送
- 与 Web 架构集成，区分流通道和控制通道

### RTSP 场景

- 使用 HTTP 将元文件传输至 Web 浏览器
- 浏览器启动播放器
- 播放器建立 RTSP 控制连接及与流媒体服务器的数据连接

![](/Images/34cc2b35-9bf7-4914-9fe5-eb1b5e617ad5.png)

### 会话初始协议（SIP）

- 长期愿景：
  - 所有电话通话、视频会议均通过互联网进行
  - 人们通过姓名或电子邮件地址而非电话号码标识身份
  - 只要被叫方愿意，无论其漫游至何处，也无论其当前使用何种 IP 设备，均可联系到被叫方
- 应用示例：
  - 视频会议
  - 流式多媒体分发
  - 即时消息
  - 在线游戏

### SIP 服务

- 呼叫建立
  - 通过 SIP 地址确定被叫方的当前 IP 地址
  - 告知被叫方主叫方希望建立呼叫
  - 主叫方与被叫方就媒体类型、编码方式达成一致
- 呼叫管理
  - 通话中添加新媒体流
  - 通话中更改编码方式
  - 邀请其他方、转移和保持呼叫

### SIP 寻址

- 使用互联网 URL
  - 统一资源定位符
  - 同时支持互联网和公共交换电话网（PSTN）地址
  - 一般格式为 user@host
- 示例
  - [sip:alan@wcom.com](https://sip:alan@wcom.com)
  - sip:J.T. Kirk [kirk@starfleet.gov](mailto:kirk@starfleet.gov)
  - [sip:+1-613-555-1212@wcom.com](https://sip:+1-613-555-1212@wcom.com);user=phone
  - sip:guest@10.64.1.1
  - [sip:790-7360@wcom.com](https://sip:790-7360@wcom.com);phone-context=VNET

### 建立呼叫

- 爱丽丝的 SIP 代理发送邀请消息，其中包含她的端口、IP 地址以及偏好接收的编码方式（PCM μ 律）
- 鲍勃的代理回复 200 OK 消息，其中包含他的端口、IP 地址以及偏好的编码方式（GSM）
- SIP 消息可通过 TCP 或 UDP 发送，此处通过 RTP/UDP 发送
- SIP 默认端口号为 5060

![](/Images/a179e5da-01fd-43bf-bfd4-b9c5955b2639.png)

### 其他可能的回复

- 拒绝呼叫
  - 鲍勃的代理可能以 “600 忙”、“503 服务不可用”、“302 已迁移”、“401 未授权” 等状态码拒绝呼叫
- 进一步协商
  - 鲍勃回复 “606 不可接受”，并列出其支持的编码器
  - 随后爱丽丝可发送新的 “INVITE” 消息，通告不同的编码器

![](/Images/f91a6e48-9251-4f38-88bb-efc6a57aec1f.png)

![](/Images/627157ea-61cc-4ba8-b6a0-a59c197d68a3.png)

### 寻找被叫方

- 必须将 SIP 地址转换为被叫方当前主机的 IP 地址
  - 鲍勃可能会四处移动（使用移动设备），从而获得不同的 IP 地址
- 由不同的 SIP 服务器处理该问题
  - 注册服务器（Registrar）：接受来自客户端（主叫方或被叫方）的 REGISTER 请求
  - 重定向服务器（Redirect）：将通往被叫方的下一跳地址发送回主叫方
  - 代理服务器（Proxy）：决定下一跳并转发请求（充当经纪人）

![](/Images/54e50849-0ed1-411d-a513-d44f37f68ba9.png)

### 一个更复杂的示例

主叫方：Alice@upenn.edu
被叫方：Bob@umass.edu
(1) 鲍勃的代理向马萨诸塞大学（umass）的 SIP 代理服务器发送 INVITE 邀请消息
(2) 代理服务器将请求转发给宾夕法尼亚大学（upenn）的注册服务器
(3) 宾夕法尼亚大学服务器返回重定向响应，指示应尝试联系 Alice@eurecom.fr
(4) 马萨诸塞大学代理服务器向欧洲通信学院（eurecom）的注册服务器发送 INVITE 邀请
(5) 欧洲通信学院注册服务器将 INVITE 请求转发至 IP 地址 197.87.54.21，该地址运行着爱丽丝的 SIP 代理程序
(6-8) SIP 响应沿原路返回
(9) 媒体数据在两个 SIP 代理之间直接传输

---

## 互联网服务质量（QoS）

- 互联网的新应用正使流量不断增加
  - 大容量客户端 / 服务器应用
  - 包含大量图形的网页
  - 实时语音和视频
- 必须在 TCP/IP 框架内支持服务质量（QoS）
  - 取代 “尽力而为” 的服务模式
  - 在路由器中添加流量控制功能
  - 提供请求 QoS 的方法

![](/Images/0ea196f2-d8d9-40c8-8412-7b3de31629e5.png)

![](/Images/5f0548e7-8f48-43b0-82f5-0209152e0ba0.png)

### 两种服务质量框架

- 综合服务架构（ISA）
- 区分服务（DS）

### 综合服务架构

- 将可区分的 IP 数据包流与一个流关联
- 具有相同的服务质量（QoS）参数
- 由源和目标 IP 地址、端口号、协议类型（TCP 或 UDP）标识
- 单向传输，可用于组播

![](/Images/5ad892eb-eb4b-490d-8839-ae0136dc2382.png)

### 综合服务架构功能

- 路由算法
  - 链路成本基于多种服务质量（QoS）参数，而非仅基于延迟
  - 基于具有相似 QoS 的流类别进行路由 / 转发
- 队列调度规则
  - 优先级队列
  - 采用多个队列而非单个队列，以考虑不同流的需求
- 丢弃策略
  - 采用选择性丢弃，而非仅丢弃新到达的数据包

- 预留协议
  - RSVP（资源预留协议），为新流按指定服务质量（QOS）级别预留资源

- 准入控制
  - 确定是否有足够资源按请求的 QOS 满足该流的需求

- 流量控制数据库
  - 存储流量控制参数

- 管理代理
  - 修改流量控制数据库
  - 指导准入控制模块设置策略

### 资源分配与 RSVP

- 在 IP 网络中为单个应用会话提供服务质量（QOS）保障
- 资源预留：路由器维护每个会话已分配资源的状态信息
  - 需要类似虚电路的机制
- 对新会话的呼叫建立请求进行准入或拒绝

![](/Images/779b55bd-1584-4168-9d97-c6186a068753.png)

### RSVP 预留流程

- 接收方
  - 生成携带预留请求的 RSVP 消息
  - 将消息向上游发送方传递
- 请求范围
  - 预留请求所传播到的发送方主机集合
- 在每个中间路由器中
  - RSVP 模块将请求提交给准入控制和策略控制模块并执行检查
  - 为每个流维护软状态（定期更新）
  - 预留请求向上传播

### 综合服务架构（ISA）的缺点

- 成本高：需要为每个流维护软状态，无法很好地扩展以处理大量流
- 复杂性：架构复杂，且需要专用的 RSVP 路由器
  - 如果路径中存在不支持 RSVP 的路由器，服务将退化为尽力而为模式
- 仅定义了极少数服务级别，缺乏灵活性

### 区分服务（DS）

- 提供多种服务等级
  - 将流量划分为不同类别
  - 网络对不同类别的流量区别对待（类比：VIP 服务与普通服务）
- 参考 RFC 2475 标准
  - 提供简单、易实现、低开销的机制
  - 支持基于性能差异的多种网络服务
  - 网络核心功能简单，边缘路由器功能相对复杂

### 区分服务（DS）的特点

- 使用 IPv4 头部的服务类型字段或 IPv6 的流量类别字段
- 定义服务等级协议（SLA）
  - 由服务提供商（ISP）与客户在使用 DS 前达成协议
  - 应用只需选择合适的 DS 字段，相同 DS 字段的流量将被统一处理
  - 例如：多个语音连接
- 分类与调节
  - 每跳行为（PHB，包括队列调度和转发策略）由 DS 字段决定
  - 边缘路由器对不符合规范的流量进行分类和整形

### DS 域

- 由单一互联网服务提供商（ISP）或一组 ISP 提供
  - 互联网中连续的一部分，在该部分上管理着一套一致的 DS 策略
  - 即对服务等级协议（SLA）参数进行相似的解释和处理
- 服务提供商配置域边缘路由器
  - 客户可能是其他域中的主机或边缘路由器
  - 为每个服务类别持续提供性能度量
  - 为来自其他域的流量匹配最合适的服务（类别）

### DS 架构

- 边缘路由器
  - 基于流的流量管理
  - 对数据包进行标记并划分为合规流量（in-profile）和违规流量（out-profile）

- 内部路由器
  - 基于类别的流量管理
  - 根据边缘路由器的标记进行缓冲和调度
  - 优先处理合规流量（in-profile）数据包

### 标记

❖ 流量配置文件：预先协商的速率 r 和桶大小 b
❖ 边缘路由器基于每个流的配置文件对数据包进行标记

标记的可能用途：
❖ 基于类别的标记：对不同类别的数据包进行不同标记
❖ 类内标记：将流中的合规部分与违规部分进行差异化标记

![](/Images/af086d3d-05c0-48ec-b313-caced6b89f02.png)

---

## 流量监管

- 目标：限制流量不超过声明的参数
- 三个常用标准：
  - （长期）平均速率：单位时间内可发送的数据包数量（长期来看）
  - 峰值速率：例如，平均 6000 个数据包 / 分钟（ppm）；峰值速率 1500 ppm
  - （最大）突发大小：连续发送的数据包最大数量（无中间空闲）
- 在流量进入网络前对其进行整形（数据包流）
  - 控制数据包的发送速率
- 两种流量整形算法
  - 漏桶算法
  - 令牌桶算法

### 漏桶算法

- 通过对数据速率进行平均，将突发流量整形为固定速率流量
- 若桶已满，可能会丢弃数据包

![](/Images/750550a5-19a5-4586-8c4c-69754be8043d.png)

- 当输入空闲时不进行任何操作
- 数据包输出速率是固定的

![](/Images/fae750ae-07ad-4192-8669-1a522a5e5a58.png)

### 令牌桶算法

- 利用令牌控制输出流量，允许输出速率变化
- 令牌生成速率固定，当桶满时可能丢弃令牌（而非数据包）

![](/Images/751afe5e-f460-4f30-8761-d0faf5b2f58e.png)

将输入限制为指定的突发大小和平均速率

- 桶可容纳 b 个令牌
- 除非桶已满，否则以 r 个令牌 / 秒的速率生成令牌
- 在时长为 t 的时间间隔内：允许进入的数据包数量小于或等于（r×t + b）

![](/Images/f333f1dd-4537-42f6-a495-0505b16e0175.png)

### 调度

❖ 调度：选择链路上下一个发送的数据包

❖ 先进先出（FIFO）调度：按数据包到达队列的顺序发送

▪ 丢弃策略：若数据包到达已满的队列，丢弃谁？

- 尾丢弃：丢弃新到达的数据包
- 优先级丢弃：基于优先级丢弃 / 移除数据包
- 随机丢弃：随机丢弃 / 移除数据包

![](/Images/49033b36-5c9a-44ee-b112-91bf033a2d00.png)

![](/Images/5a403902-2323-433f-a1c6-b7526c48000d.png)

### 用于服务质量（QoS）保障的流量监管与调度

❖ 令牌桶与加权公平队列（WFQ）结合，可提供有保障的延迟上限，即实现 QoS 保障！

![](/Images/cd641112-c344-4c41-b81c-6a364d338924.png)

### 边缘路由器的功能

基于流的流量分类与调节

- 分类器：将数据包流划分为不同类别
- 计量器：衡量流流量是否符合配置文件要求
- 标记器：必要时通过重标记代码点实现流量监管
- 整形器：使用令牌桶对数据包流进行整形
- 丢弃器：若流量速率严重超过类别配置文件中指定的速率，则丢弃数据包

![](/Images/6240a210-8d52-420b-9003-823caddca0c5.png)

### 内部路由器的功能

- 在域内对区分服务（DS）代码点进行一致解释
  - 基于代码点（类别）处理数据包的简单机制
- 分类器
  - 基于 DS 代码点、源和目标地址、高层协议等对数据包进行区分
- 队列管理
  - 每跳行为（PHB）：队列根据代码点给予优先处理
  - 数据包丢弃规则规定当缓冲区饱和时丢弃哪些数据包

![](/Images/fdf89f6b-c211-4f6e-adf6-5029e62bec96.png)

总结

- 多媒体网络应用
  - 存储媒体流
    - 动态自适应流媒体（DASH）
  - 网络语音通信（VoIP）
    - Skype
    - 网络地址转换（NAT）
  - 直播流

- 实时传输协议
  - RTP（实时传输协议）、RTCP（实时传输控制协议）、RTSP（实时流协议）、SIP（会话初始协议）

- 互联网服务质量（QoS）
  - 综合服务架构（ISA）
    - 架构
    - 资源分配（RSVP，资源预留协议）
  - 区分服务（DS）
    - 边缘路由器
      - 基于流的流量管理
    - 内部路由器
      - 基于类别的流量管理
    - 流量监管：令牌桶算法
    - 调度：加权公平队列（WFQ）
