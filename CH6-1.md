# CH6-1

##  链路层

-  链路层服务

  - 成帧（Framing）

  - 链路接入

  - 可靠传输

  - 错误检测与纠正

- 局域网（LAN）
  - 令牌环
  - 以太网

- 媒体访问控制（MAC）
- 网桥与二层交换机
- 无线网络

---

## 链路层服务

### 直接链路

-  主机和路由器均为节点

- 连接相邻节点的通信信道称为链路

- 链路的不同类型

  - 有线点对点链路

  - 有线多路访问链路（局域网）

  - 无线链路（WiFi）

### 数据链路层

-  二层数据包：帧，封装数据报
-  在相邻节点之间或同一局域网的节点之间传输数据

![](/Images/6de482be-251a-4bc9-9038-0eb135561242.png)

### 实现链路层

-  在主机和路由器（交换机）中实现

-  链路层在 “适配器” 中实现

  - 即网络接口卡（NIC）

  - 如以太网卡、802.11 无线网卡

    -  实现链路层和物理层功能

    -  接入主机的系统总线

    -  由硬件、软件和固件共同组成

### 链路层服务

提供四项主要服务

-  成帧

  - 将上层数据封装为帧，添加帧头和帧尾

  

   链路接入

  - 协调共享多路访问媒体的接入

  - 帧头中使用 “MAC” 地址标识源端和目的端

  - 半双工与全双工：是否支持同时收发数据

-  链路上的可靠传输
  -  很少在低误码率链路（如光纤）中使用
  - 无线链路：误码率较高
  - 流量控制：在相邻发送节点与接收节点之间进行速率调节
- 错误检测与纠正
  - 处理由信号衰减或噪声导致的错误
  - 接收方检测错误的存在
  - 向发送方发送重传信号或丢弃帧

![](/Images/18ecf14a-fd1d-4fdc-88a2-38d17885d0ae.png)

![](/Images/d5e12172-368d-44df-b231-af56dfd14af0.png)

---

### 多路访问控制（MAC）

-  场景：共享广播信道
  - 必须避免多个节点同时传输数据
  -  否则冲突会导致数据传输混乱
-  需要分布式算法来确定哪个节点可以传输
-  多路访问协议
  -  用于确定节点如何共享信道的分布式算法，即确定节点何时可以传输
-  关于信道共享的通信必须使用信道本身！
  - 没有用于协调的带外信道

---

![](/Images/3859d72a-0a0c-4dde-bb8a-f43bbeb6949c.png)

### 停止等待协议

-  发送方：传输帧
-  接收方：接收帧并回复确认（ACK）
-  发送方：在发送下一帧前等待确认
-  接收方可通过不发送确认来停止流量
-  适用于大帧传输

### 滑动窗口

-  允许多个帧在传输中
-  接收方有大小为 Win 的缓冲区（窗口）
-  发送方无需确认即可发送最多 Win 个帧
-  每个帧都有编号
-  确认（ACK）包含期望接收的下一帧编号
-  序列号由大小为 k 的字段限制
-  帧编号按 2 的 k 次方取模
-  问题：给定窗口大小 Win，如何设置 k？
-  答案：Win≤2ᵏ（重点）

![](/Images/483281d1-e8a0-4325-b750-7cdf5bc3d9cc.png)

![](/Images/4770f8a6-d24c-48d5-9606-2376679fb3a9.png)

### 滑动窗口中的错误处理

-  回退 N 协议（Go Back N）

  - 若出现错误，回复拒绝（NAK）

  - 错误帧及所有后续帧均需重传

-  选择性重传（Selective Reject）

  - 仅需重传被拒绝的错误帧

  - 接收方必须维护足够大的缓冲区

---

![](/Images/c34591de-c8df-4166-ba6a-1dfaa571b1d4.png)

![](/Images/d1c76125-8b3c-4f77-8377-f6745ae26fb5.png)

### 循环冗余校验

-  广泛应用于基于硬件的实现
-  将数据位 D 视为一个二进制数
-  选择 r+1 位模式（生成器或多项式）G

- G 被称为密钥，发送方和接收方预先知晓该密钥
  -  由于 D ∗ 2ʳ = a ∗ G ⊕ R，因此 D ∗ 2ʳ ⊕ R = a ∗ G
  -  发送方：发送 D ∗ 2ʳ ⊕ R，用 <D,R> 表示
  -  接收方：收到 <D,R> 时

- 若 <D,R> 能被 G（模 2 运算）整除，则无错误

- 若 <D,R> 除以 G 的余数非零，则检测到错误！
-  限制：可检测长度小于 r+1 位的突发错误

![](/Images/d490ac18-2efb-43a2-98eb-a44708a37f1d.png)

加减不进位，不借位

---

## 局域网（LAN）

![](/Images/28352611-f9cf-40d7-8b37-776827cde812.png)

![](/Images/21db4924-0533-4bde-b38c-77dcb0e05620.png)

---

### 令牌环

-  一种局域网协议，IEEE 802.5
-  由 IBM 的商用令牌环技术发展而来
-  由于 IBM 的影响力，令牌环曾获得广泛认可
-  但从未达到以太网的普及程度

### 令牌环操作

-  每个中继器（repeater）通过单向传输链路与另外两个中继器相连
-  中继器作为连接点
-  数据逐位从一个中继器传输至下一个中继器
-  中继器对每个比特进行再生和重传
-  中继器执行数据插入、数据接收和数据移除操作
-  帧在环网中传输一圈后由发送方移除

![](/Images/aa06c3af-be86-41ce-8df8-b862967934ad.png)

- 监听状态

  -  扫描经过的比特流以查找模式
    - 连接站点的地址与目标地址对比
    - 传输的令牌权限

-  复制输入比特并发送至连接的站点

  -  若目标地址匹配

  - 在转发每个比特的同时

- 对经过的比特进行修改
  - 例如：指示数据包已被复制（确认）
  - 或进行预留

- 传输状态

  - 回收帧并传回站点进行校验（确认）
  - 可能缓存其他设备的帧以便后续重传

- 旁路状态
  - 仅作为连接器，不执行其他操作

![](/Images/7ad765b3-46a1-4ca7-9bc3-e2daf4d608d0.png)

---

### 802.5 MAC 协议

-  空闲时会有小帧（令牌）循环
-  站点等待令牌
-  将令牌中的某一比特修改为帧起始符（SOF），以构成数据帧
-  附加数据帧的其余部分
-  帧完成环网传输后被发送站点回收
-  站点在传输完成后（当返回帧的前缘到达时）插入新令牌
-  轻负载时存在一定低效性
-  重负载时呈现**轮询机制**特性

![](/Images/e92372aa-0476-46b4-bc1e-c3c12c6c6a1b.png)

![](/Images/832ec29a-8d2f-4f2d-a6eb-bd1367959c83.png)

---

## 以太网

-  占主导地位的有线局域网技术：
-  网卡仅需 20 美元，成本低廉
-  是首个得到广泛应用的局域网技术
-  相比令牌环局域网和异步传输模式（ATM），更为简单且成本更低
-  在速度竞赛中持续演进：从 10 兆比特每秒提升至 10 吉比特每秒

### 以太网：物理拓扑

-  总线型：在 20 世纪 90 年代中期前较为流行

  - 所有节点处于同一冲突域（可能互相发生冲突）

-  星型：如今占主导地位

  - 中心部署有源交换机

  - 每条 “分支” 运行独立的以太网协议（节点间不会互相冲突）

![](/Images/58a08cd6-2a1d-40ee-ba90-5d525e8cedff.png)

### 广播以太网与交换以太网

-  最初作为广播技术被发明
  -  主机共享信道
  - 每个数据包会被所有连接的主机接收
  - 采用载波侦听多路访问 / 冲突检测（CSMA/CD）作为媒体访问控制方式

-  现代以太网采用 “交换” 架构
  -  交换机之间、主机与交换机之间通过点对点链路连接
  - 无信道共享→无需 CSMA/CD
  - 采用 “自学习” 和 “生成树” 算法实现路由

### 以太网的演进

- 几乎改变了除帧格式之外的所有内容
- 从共享介质同轴电缆发展到专用链路
- 速度从 3 兆比特 / 秒提升至 100 吉比特 / 秒
- 从电信号传输发展到光信号传输
- 启示：合适的接口能够适应诸多变化
- 在演进实现方式的同时保持接口不变（向后兼容）

### 以太网：不可靠、无连接

-  无连接：发送方和接收方网卡之间无需握手
-  不可靠：接收方网卡不会向发送方网卡发送确认（ACK）或拒绝（NAK）
  -  仅当初始发送方使用高层可靠数据传输协议（如 TCP）时，丢弃帧中的数据才能被恢复，否则丢弃的数据将永久丢失

### 以太网帧格式

- 封装 IP 数据报：前导码，目的地址，源地址，类型，数据，CRC 校验码
- 前导码：7 字节用于时钟同步，1 字节指示帧起始
- 地址：6 字节
- 类型：2 字节，标识高层协议（如 IP）
- 数据负载：最大 1500 字节，最小 46 字节
- CRC：4 字节，用于错误检测

![](/Images/89b234e1-8c45-4755-ad24-a384d6b9a869.png)

---

### 媒体访问控制（MAC）地址

-  MAC 地址
  -  与网络适配器关联的数字地址
  - 48 位的平面命名空间（如十六进制表示的 00-15-C5-49-04-A9）
  - 具有唯一性，在适配器制造时硬编码于其中
- 分层分配机制
  - 地址块：由 IEEE 分配给供应商（如戴尔）
    - 前 24 位（如 00-15-C5-**-**-**）
  - 适配器地址：由供应商从其分配的地址块中进行分配
    - 后 24 位

### 成帧

-  物理层在链路上传输比特
-  但连接在同一物理介质上的两台主机需要能够交换帧
  -  这是链路层提供的服务
  -  由网络适配器实现
-  成帧问题：链路层如何确定每个帧的开始和结束？

简单方法：计数字节

-  发送方在头部包含字节数
- ![](/Images/09b57cda-f0b3-4efb-9859-3090e78f71f8.png)
-  接收方提取该字节数的数据体
- 如果计数字段被损坏会怎样？
- ![](/Images/e82d1cb5-9867-4dba-bbbd-502b948efcfd.png)
- 链路层将对错误字节成帧→产生成帧错误
- CRC 会指示丢弃该帧，但下一帧呢？

### 失步

-  一旦链路上的成帧出现失步，这种状态可能会持续存在
-  需要一种方法来重新同步

### 带标记位的成帧

-  用特殊的 “标记” 位模式界定帧
  -  例如，01111110 表示起始，01111111 表示结束
  - ![](/Images/289b2716-5baf-4c5f-88f4-bb566188972a.png)
-  若帧内出现标记位怎么办？
- 解决方案：位填充
  - 发送方在帧内容中遇到五个连续 1 后始终插入一个 0
  - 接收方始终删除五个连续 1 之后出现的 0

### 当接收方看到五个连续的 1 时...（重点）

-  若下一个比特为 0，则将其删除，并重新开始计数
-  因为这一定是填充位；我们不可能处于帧的起始 / 结束位置（帧起始 / 结束位包含六个或七个连续的 1）
- 若下一个比特为 1（即已看到六个连续的 1），则：

- 若后续比特为 0，则这是帧的起始
  - 因为接收方已检测到 01111110（帧起始标记）
- 若后续比特为 1，则这是帧的结束
  - 因为接收方已检测到 01111111（帧结束标记）

![](/Images/f3dc02a4-a88f-463f-a151-7f33f354f547.png)

![](/Images/926649fb-2815-4f36-92b6-223e240624db.png)

![](/Images/fcb4ada4-035f-48cb-bbb4-eaf240ff5681.png)

---

![](/Images/7f030976-8517-4647-816c-b21ed00d854b.png)
